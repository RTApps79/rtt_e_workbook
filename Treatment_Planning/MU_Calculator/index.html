<!DOCTYPE html>
<html>
<head>
    <title>MU Calculator Activity (Photon/Electron)</title>
    <meta charset="UTF-8">
    <style>
        /* Styles from your provided calculator */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto; /* Center body content */
            padding: 20px; /* Add some padding around */
            background-color: #f4f4f4; /* Consistent background */
            position: relative;
            min-height: 100vh;
            padding-bottom: 120px; /* Space for footer and nav */
        }
        #calculator-wrapper { /* Added a wrapper for better centering and spacing */
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #mainLayout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        #inputColumn {
            flex: 1;
            min-width: 400px;
        }
        #visualizationColumn {
            flex: 1;
            min-width: 520px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas#beamCanvas {
            border: 1px solid black;
            background-color: #000;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .output {
            background: #f5f5f5;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #ccc;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: monospace;
            border-radius: 5px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select {
            padding: 8px;
            width: calc(100% - 18px);
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="radio"] {
            margin-right: 5px;
        }
        button { /* General button style from lesson for consistency */
            background-color: #007bff; color: white; padding: 10px 20px;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 1em; margin: 5px; transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        #controlButtons button, #printEmailButtons button { /* Specific for calc */
             background-color: #4CAF50;
             padding: 10px 18px;
             margin-top:15px;
        }
         #controlButtons button:hover, #printEmailButtons button:hover {
            background-color: #45a049;
        }


        .tooltip { color: #666; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .step { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .error { color: red; font-weight: bold; border: 1px solid red; padding: 10px; background-color: #ffeeee; border-radius: 4px; margin-top: 10px; }
        .output p { margin: 5px 0; }
        .output strong { color: #0056b3; }
        .output hr { margin: 10px 0; border: 0; border-top: 1px solid #ccc; }
        .output .final-mu { font-size: 1.3em; font-weight: bold; color: #d9534f;}
        .jawInputGroup label { display: inline-block; width: auto; margin-right: 5px; }
        .jawInputGroup input[type="number"] { width: 60px; margin-right: 15px; display: inline-block; }
        .jawModeBox label { display: inline-block; padding: 5px 10px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer; border-radius: 4px; margin-right: -1px; font-weight: normal; }
        .jawModeBox input[type="radio"] { display: none; }
        .jawModeBox input[type="radio"]:checked + label { background-color: #e0e0e0; border-color: #bbb; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        #beamImageBox { margin-top: 15px; padding: 10px; border: 1px solid #ccc; background-color: #eee; border-radius: 4px; text-align: center;}
        #beamImageBox label { display: inline-block; margin: 0 10px 0 2px; font-weight: normal; }
        #visualizationColumn label { display: inline-block; width: auto; margin-right: 5px; }
        #visualizationColumn input[type="number"] { width: 70px; display: inline-block;}

        /* Footer */
        footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            text-align: center; padding: 15px 0; background-color: #e9ecef;
            color: #6c757d; font-size: 0.9em; border-top: 1px solid #dee2e6;
        }
        /* Post-Activity Navigation */
        .post-activity-nav {
            text-align: center; margin-top: 30px; padding: 20px 0;
            background-color: #f8f9fa; border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }
        .post-activity-nav button { margin: 5px 10px; }
        .post-activity-nav button.repeat { background-color: #28a745; } /* Green */
        .post-activity-nav button.repeat:hover { background-color: #218838; }
        .post-activity-nav button.menu { background-color: #6c757d; } /* Grey */
        .post-activity-nav button.menu:hover { background-color: #5a6268; }


        @media print {
            body { max-width: 100%; margin: 10px; padding-bottom: 0;}
            body * { visibility: hidden; }
            #calculator-wrapper, #inputColumn, #output, #output *, #mainLayout { visibility: visible; } /* Show calc and output */
            #mainLayout { display: block; }
            #visualizationColumn, #controlButtons button:not(#resetButton), #printEmailButtons, .post-activity-nav, footer, #beamImageBox { display: none; }
            #inputColumn { width: 100%; }
            .form-section { border: 1px solid #aaa; }
            #output { position: static; width: 100%; border: 1px solid #aaa; background: none; padding: 10px; margin: 10px 0; font-size: 11pt; white-space: pre-wrap; }
            #output #printEmailButtons { display: none; }
            #output h3, #output p, #output hr, #output span { visibility: visible; }
        }
    </style>
</head>
<body>
    <div id="calculator-wrapper"> <h1>Merged MU Calculator</h1>
        <div id="mainLayout">
            <div id="inputColumn">
                <div class="form-section" id="section-general">
                    <div class="step">Step 1: General Information</div>
                    <label for="plannerName">Planner Name:</label>
                    <input type="text" id="plannerName">

                    <label for="radOncName">Rad Oncologist Name:</label>
                    <input type="text" id="radOncName">

                    <label for="fieldName">Field Name:</label>
                    <input type="text" id="fieldName" placeholder="e.g., R AP Supraclav / L Post Electron Boost">
                </div>
                <div class="form-section" id="section-technique">
                    <div class="step">Step 2: Treatment Technique</div>
                    <label for="technique">Treatment Technique:</label>
                    <select id="technique">
                        <option value="SSD">Photon SSD</option>
                        <option value="SAD">Photon SAD</option>
                        <option value="electron">Electron</option>
                    </select>
                </div>
                <div id="photonInputs">
                    <div class="form-section" id="photonBeamParams">
                        <div class="step">Step 3: Photon Parameters</div>
                        <label for="energy">Beam Energy (MV):</label>
                        <select id="energy">
                            <option value="6">6 MV</option>
                            <option value="10">10 MV</option>
                            <option value="18">18 MV</option>
                        </select>
                        <div id="ssdFields">
                            <label for="rxDose">Prescription Dose (cGy):</label>
                            <input type="number" id="rxDose" min="0" value="180">
                            <label for="depth">Depth of Calculation (cm):</label>
                            <input type="number" id="depth" min="0" value="5">
                            <label for="ssd">SSD (cm):</label>
                            <input type="number" id="ssd" min="0" value="100">
                            <label for="dmax">Dmax (cm): <span class="tooltip">(Auto-updated)</span></label>
                            <input type="number" id="dmax" min="0" readonly>
                        </div>
                        <div id="sadFields" style="display:none">
                            <label for="rxDoseSAD">Prescription Dose (cGy):</label>
                            <input type="number" id="rxDoseSAD" min="0" value="180">
                            <label for="depthSAD">Depth of Calculation (cm):</label>
                            <input type="number" id="depthSAD" min="0" value="10">
                            <label for="sad">SAD (cm): <span class="tooltip">(Assumed 100cm)</span></label>
                            <input type="number" id="sad" value="100" readonly>
                        </div>
                        <label>X Jaws (cm)</label>
                        <div class="jawModeBox">
                            <input type="radio" value="sym" name="xjawmode" id="xsym" checked>
                            <label for="xsym">Sym</label>
                            <input type="radio" value="indep" name="xjawmode" id="xindep">
                            <label for="xindep">Indep</label>
                        </div>
                        <div class="jawInputGroup">
                            <span id="xSymInput">
                                <label for="xwidth">Width:</label>
                                <input type="number" id="xwidth" value="10" min="0">
                            </span>
                            <span id="xIndepInput" style="display: none;">
                                <label for="x1">X1:</label>
                                <input type="number" id="x1" value="-5">
                                <label for="x2">X2:</label>
                                <input type="number" id="x2" value="5">
                            </span>
                        </div>
                        <label>Y Jaws (cm)</label>
                        <div class="jawModeBox">
                            <input type="radio" value="sym" name="yjawmode" id="ysym" checked>
                            <label for="ysym">Sym</label>
                            <input type="radio" value="indep" name="yjawmode" id="yindep">
                            <label for="yindep">Indep</label>
                        </div>
                        <div class="jawInputGroup">
                            <span id="ySymInput">
                                <label for="ywidth">Height:</label>
                                <input type="number" id="ywidth" value="10" min="0">
                            </span>
                            <span id="yIndepInput" style="display: none;">
                                <label for="y1">Y1:</label>
                                <input type="number" id="y1" value="-5">
                                <label for="y2">Y2:</label>
                                <input type="number" id="y2" value="5">
                            </span>
                        </div>
                        <label for="fieldSize">Equivalent Square Field Size (cm): <span class="tooltip">(Auto-calculated)</span></label>
                        <input type="number" id="fieldSize" min="0" readonly>
                        <label for="trayType">Tray:</label>
                        <select id="trayType">
                            <option value="none">None</option>
                            <option value="5mmSolid">5 mm Solid</option>
                            <option value="5mmSlotted">5 mm Slotted</option>
                        </select>
                        <label for="trayFactor">Tray Factor (TF): <span class="tooltip">(Auto-updated)</span></label>
                        <input type="number" id="trayFactor" value="1" min="0.1" max="1" step="0.0001" readonly>
                        <label for="wedgeAngle">Wedge Angle:</label>
                        <select id="wedgeAngle">
                            <option value="0">None</option>
                            <option value="15">15 degree</option>
                            <option value="30">30 degree</option>
                            <option value="45">45 degree</option>
                            <option value="60">60 degree</option>
                        </select>
                        <label for="wedgeFactor">Wedge Factor (WF): <span class="tooltip">(Auto-updated)</span></label>
                        <input type="number" id="wedgeFactor" value="1" min="0.1" max="1" step="0.0001" readonly>
                    </div>
                </div>
                <div id="electronInputs" style="display:none;">
                    <div class="form-section" id="electronBeamParams">
                        <div class="step">Step 3: Electron Parameters</div>
                        <label for="electronEnergy">Beam Energy (MeV):</label>
                        <select id="electronEnergy">
                            <option value="6">6 MeV</option>
                            <option value="9">9 MeV</option>
                            <option value="12">12 MeV</option>
                            <option value="15">15 MeV</option>
                            <option value="18">18 MeV</option>
                            <option value="20">20 MeV</option>
                            <option value="21">21 MeV</option>
                        </select>
                        <label for="applicatorSize">Applicator Size:</label>
                        <select id="applicatorSize">
                            <option value="5x5">5x5 cm</option>
                            <option value="10x10">10x10 cm</option>
                            <option value="15x15">15x15 cm</option>
                            <option value="20x20">20x20 cm</option>
                            <option value="25x25">25x25 cm</option>
                        </select>
                        <span class="tooltip">(Note: PDD Approximation only valid for 10x10)</span>
                        <label for="rxDoseElectron">Prescription Dose (cGy):</label>
                        <input type="number" id="rxDoseElectron" min="0" value="200">
                        <label for="depthElectron">Depth of Calculation (cm):</label>
                        <input type="number" id="depthElectron" min="0" value="2.0">
                        <label for="ssdElectron">Treatment SSD (cm):</label>
                        <input type="number" id="ssdElectron" min="0" value="100">
                        <label for="dmaxElectron">Approximate Dmax Depth (cm): <span class="tooltip">(Auto-updated)</span></label>
                        <input type="number" id="dmaxElectron" readonly>
                        <label for="effectiveSSDElectron">Effective SSD (cm): <span class="tooltip">(Auto-updated)</span></label>
                        <input type="number" id="effectiveSSDElectron" readonly>
                        <label for="outputFactorElectron">Output Factor (Cone Factor): <span class="tooltip">(Auto-updated)</span></label>
                        <input type="number" id="outputFactorElectron" readonly>
                        <span class="tooltip">(Irregular fields require manual ROF determination)</span>
                    </div>
                </div>
                <div id="controlButtons">
                    <button onclick="calculateMU()">Calculate Monitor Units</button>
                    <button id="resetButton">Reset</button>
                </div>
                <div class="output" id="output">Calculation results will appear here.</div>
                <div id="printEmailButtons" style="display: none; margin-top: 10px;">
                    <button onclick="printResults()">Print Results</button>
                    <button onclick="emailResults()">Email Results</button>
                </div>
            </div>
            <div id="visualizationColumn">
                <canvas id="beamCanvas" width="500" height="500">
                    Your browser does not support the HTML5 canvas feature.
                </canvas>
                <div>
                    <label for="collimatorAngle">Collimator Rotation (°):</label>
                    <input type="number" id="collimatorAngle" value="0" step="1">
                </div>
                <div id="beamImageBox">
                    Background Image:
                    <input type="radio" value="none" name="beamImage" id="imgNone" checked>
                    <label for="imgNone">None</label>
                    <input type="radio" value="spine" name="beamImage" id="imgSpine">
                    <label for="imgSpine">Spine</label>
                    <input type="radio" value="pelvis" name="beamImage" id="imgPelvis">
                    <label for="imgPelvis">Pelvis</label>
                    <input type="radio" value="brain" name="beamImage" id="imgBrain">
                    <label for="imgBrain">Brain</label>
                    <span class="tooltip">(Display only)</span>
                </div>
            </div>
        </div> <div class="post-activity-nav">
            <h3>Options</h3>
            <button class="menu" onclick="window.location.href='https://rtapps79.github.io/rtt_e_workbook/Ethics/'">Back to Ethics Menu</button>
            <button class="repeat" onclick="window.location.reload()">Reset Calculator</button>
            <button onclick="window.location.href='treatment_techniques_mu_lesson.html#lesson-page-8'">Back to Lesson Summary</button>
        </div>

    </div> <footer>
        <p>&copy; 2025 RTApps. All rights reserved.</p>
    </footer>

    <script>
        // --- Global Variables ---
        let canvas, ctx, currentImage;
        const beamDim = 500; // Canvas dimensions
        const scale = 10.0;  // Pixels per cm at isocenter for visualization

        const imageUrls = {
            none: null,
            spine: "https://static.wixstatic.com/media/6f7b64_498f0423091a4f57951242d1e573563d~mv2_d_1924_4823_s_2.jpg/v1/fill/w_250,h_626,al_c,q_90,enc_auto/6f7b64_498f0423091a4f57951242d1e573563d~mv2_d_1924_4823_s_2.jpg",
            pelvis: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRcK9oD-R3O3Nt7FQeUZ_jAjfws1z48JyKQcA&s",
            brain: "https://prod-images-static.radiopaedia.org/images/13205453/221b52a9fd6ca1675dccde4728534d_big_gallery.jpg"
        };
        const referenceData = { "6": { "SSD": 0.993, "SAD": 1.000, "dmax": 1.5 }, "10": { "SSD": 0.968, "SAD": 1.015, "dmax": 2.5 }, "18": { "SSD": 0.944, "SAD": 1.000, "dmax": 3.5 }};
        const wedgeFactors = { "6": { "0": 1.0, "15": 0.828, "30": 0.714, "45": 0.580, "60": 0.424 }, "10": { "0": 1.0, "15": 0.895, "30": 0.802, "45": 0.702, "60": 0.513 }, "18": { "0": 1.0, "15": 0.866, "30": 0.775, "45": 0.656, "60": 0.449 }};
        const trayFactors = { "6": { "none": 1.0, "5mmSolid": 0.97, "5mmSlotted": 0.98 }, "10": { "none": 1.0, "5mmSolid": 0.97, "5mmSlotted": 0.98 }, "18": { "none": 1.0, "5mmSolid": 0.98, "5mmSlotted": 0.99 }};
        const scData = { "6": { 4: 0.948, 5: 0.961, 6: 0.97, 7: 0.979, 8: 0.987, 9: 0.994, 10: 1, 11: 1.004, 12: 1.009, 13: 1.013, 14: 1.017, 15: 1.021, 16: 1.024, 17: 1.028, 18: 1.031, 19: 1.03, 20: 1.033, 22: 1.035, 24: 1.038, 26: 1.041, 28: 1.045, 30: 1.048 }, "10": { 4: 0.938, 5: 0.951, 6: 0.962, 7: 0.973, 8: 0.982, 9: 0.991, 10: 1, 11: 1.005, 12: 1.014, 13: 1.018, 14: 1.023, 15: 1.026, 16: 1.037, 17: 1.04, 18: 1.044, 19: 1.048, 20: 1.051, 22: 1.052, 24: 1.054, 26: 1.057, 28: 1.061, 30: 1.063 }, "18": { 4: 0.914, 5: 0.931, 6: 0.948, 7: 0.965, 8: 0.978, 9: 0.989, 10: 1, 11: 1.006, 12: 1.012, 13: 1.017, 14: 1.023, 15: 1.029, 16: 1.032, 17: 1.036, 18: 1.039, 19: 1.043, 20: 1.046, 22: 1.051, 24: 1.052, 26: 1.055, 28: 1.058, 30: 1.061 }};
        const spData = { "6": { 4: 0.981, 5: 0.983, 6: 0.987, 7: 0.990, 8: 0.993, 9: 0.997, 10: 1.000, 11: 1.003, 12: 1.007, 13: 1.010, 14: 1.013, 15: 1.016, 16: 1.017, 17: 1.020, 18: 1.022, 19: 1.025, 20: 1.027, 22: 1.017, 24: 1.019, 26: 1.03 }, "10": { 4: 0.978, 5: 0.978, 6: 0.984, 7: 0.988, 8: 0.992, 9: 0.996, 10: 1.000, 11: 1.003, 12: 1.006, 13: 1.008, 14: 1.011, 15: 1.014, 16: 1.015, 17: 1.016, 18: 1.017, 19: 1.023, 20: 1.026, 22: 1.030, 24: 1.031, 26: 1.034 }, "18": { 4: 0.986, 5: 0.991, 6: 0.994, 7: 0.995, 8: 0.997, 9: 0.998, 10: 1.000, 11: 1.002, 12: 1.002, 13: 1.004, 14: 1.004, 15: 1.005, 16: 1.007, 17: 1.007, 18: 1.008, 19: 1.006, 20: 1.009, 22: 1.011, 24: 1.013, 26: 1.016 }};
        const pddData = { "6": { "0": { 0: 100, 0.5: 96.8, 1: 97.4, 1.5: 100, 2: 99.8, 4: 85.3, 5: 79.9, 6: 74.8, 7: 70.1, 8: 65.7, 9: 61.5, 10: 57.7, 11: 54, 12: 50.7, 13: 47.5, 14: 44.6, 15: 41.8, 16: 39.2, 17: 36.6, 18: 34.5, 19: 32.4, 20: 30.4, 21: 28.6, 22: 26.8, 23: 25.2, 24: 23.6 }, /* ... more PDD data ... */ "35":{0:98.5,0.5:98.9,1:99,1.5:95.6,2:92.3,4:88.9,5:88.9,6:85.7,7:82.5,8:79.1,9:75.7,10:71.9,11:69.2,12:66.3,13:63.5,14:60.2,15:57.6,16:55.2,17:52.6,18:50.2,19:47.9,20:45.8,21:43.5,22:41.6,23:39.5,24:38.5} }, "10": { /* 10MV PDD data */ "30": {0:94.4,1:93.1,2:98.6,2.5:100,3:95.3,4:98.8,5:92,6:88.7,7:82.5,8:82.6,9:73.2,10:72.8,11:69,12:66.3,13:64.7,14:62.9,15:59.5,16:57,17:50.6,18:47.9,19:43.4,20:40.6,21:45.8,22:41.9,23:40.5,24:40.3,25:40.5,26:37.3,27:36.5,28:35.2,29:34.9,30:34 } }, "18": { /* 18MV PDD data */ "32.0": {0:42,1:86.8,2:98,3:99.1,3.5:100,4:98.8,5:95.8,6:93,7:89.8,8:86.7,9:83.9,10:81.1,11:78.1,12:75.2,13:72.5,14:69.8,15:67.4,16:65,17:62.7,18:60.4,19:58.3,20:56.2,21:54.2,22:52.3,23:50.3,24:48.4,25:46.6,26:44.8,27:43.2,28:41.6,29:40,30:38.5} }};
        const tmrData = { "6": { "0": { 0: 0.186, 1: 0.957, 1.5: 1, 3: 0.982, 4: 0.936, 5: 0.894, 6: 0.853, 7: 0.814, 8: 0.777, 9: 0.742, 10: 0.708, 11: 0.645, 12: 0.616, 13: 0.588, 14: 0.561, 15: 0.536, 16: 0.511, 17: 0.488, 18: 0.466, 19: 0.445, 20: 0.424, 21: 0.405, 22: 0.387, 23: 0.37, 24: 0.352, 25: 0.337, 26: 0.321, 27: 0.307, 28: 0.292, 29: 0.279, 30: 0.266 }, /* ... more TMR data ... */ "30":{0:0.456,1:0.971,1.5:1,3:0.981,4:0.981,5:0.945,6:0.946,7:0.912,8:0.912,9:0.89,10:0.869,11:0.824,12:0.8,13:0.776,14:0.751,15:0.73,16:0.71,17:0.688,18:0.667,19:0.645,20:0.623,21:0.6,22:0.579,23:0.554,24:0.527,25:0.501,26:0.474,27:0.449,28:0.424,29:0.396,30:0.371} }, "10": { /* 10MV TMR data */ "30": {0:0.3,1:0.95,2:1,2.5:1.03,3:1.028,4:1.016,5:1,6:0.982,7:0.96,8:0.941,9:0.924,10:0.896,11:0.886,12:0.869,13:0.842,14:0.829,15:0.809,16:0.784,17:0.764,18:0.744,19:0.724,20:0.696,21:0.68,22:0.672,23:0.648,24:0.63,25:0.606,26:0.595,27:0.589,28:0.581,29:0.563,30:0.556} }, "18": { /* 18MV TMR data */"32.0":{0:0.42,1:0.868,2:0.98,3:0.991,3.5:1,4:0.988,5:0.958,6:0.93,7:0.898,8:0.867,9:0.839,10:0.811,11:0.781,12:0.752,13:0.725,14:0.698,15:0.674,16:0.65,17:0.627,18:0.604,19:0.583,20:0.562,21:0.542,22:0.523,23:0.503,24:0.484,25:0.466,26:0.448,27:0.432,28:0.416,29:0.4,30:0.385} }};
        const electronEnergies = ["6", "9", "12", "15", "18", "20", "21"];
        const applicatorSizes = ["5x5", "10x10", "15x15", "20x20", "25x25"];
        const electronOutputFactors = { "6": { "5x5": 0.787, "10x10": 0.967, "15x15": 1.000, "20x20": 1.013, "25x25": 0.989 }, "9": { "5x5": 0.903, "10x10": 1.000, "15x15": 1.000, "20x20": 0.987, "25x25": 0.966 }, "12": { "5x5": 0.932, "10x10": 1.008, "15x15": 1.000, "20x20": 0.976, "25x25": 0.958 }, "15": { "5x5": 0.966, "10x10": 1.020, "15x15": 1.000, "20x20": 0.982, "25x25": 0.958 }, "18": { "5x5": 1.002, "10x10": 1.023, "15x15": 1.000, "20x20": 0.986, "25x25": 0.958 }, "21": { "5x5": 1.023, "10x10": 1.021, "15x15": 1.000, "20x20": 0.977, "25x25": 0.956 }};
        const electronEffectiveSSDs = { "6": { "5x5": 66.3, "10x10": 89.6, "15x15": 97.2, "20x20": 102.6, "25x25": 102.5 }, "9": { "5x5": 76.1, "10x10": 97.3, "15x15": 101.4, "20x20": 101.7, "25x25": 99.8 }, "12": { "5x5": 81.2, "10x10": 100.0, "15x15": 107.5, "20x20": 105.9, "25x25": 102.4 }, "15": { "5x5": 78.9, "10x10": 97.5, "15x15": 103.1, "20x20": 104.8, "25x25": 103.4 }, "18": { "5x5": 77.8, "10x10": 96.9, "15x15": 101.3, "20x20": 106.1, "25x25": 101.6 }, "21": { "5x5": 74.9, "10x10": 97.7, "15x15": 103.6, "20x20": 100.9, "25x25": 101.4 }};
        const electronDmaxData = { "6": 1.2, "9": 2.0, "12": 2.8, "15": 3.2, "20": 3.5 };
        const electronApproxPDDData = { "6": { "10x10": { 0: 78, 1.2: 100, 1.7: 90, 2.3: 50 } }, "9": { "10x10": { 0: 81, 2.0: 100, 2.7: 90, 3.5: 50 } }, "12": { "10x10": { 0: 86, 2.8: 100, 3.9: 90, 5.0: 50 } }, "15": { "10x10": { 0: 91, 3.2: 100, 4.9: 90, 6.3: 50 } }, "20": { "10x10": { 0: 95, 3.5: 100, 6.0: 90, 8.5: 50 } }};
        const ELECTRON_CALIBRATION_DOSE_RATE = 1.0;
        const ELECTRON_STANDARD_SSD = 100.0;

        // --- Paste ALL other JS functions from your calculator here ---
        // (displayError, displayResult, formatResultsForText, updatePhotonDefaults, ...)
        // (updateElectronDefaults, updateDmax, changeTechnique, updateWedgeFactor, ...)
        // (updateTrayFactor, calculateEquivalentSquare, updateJawInputs, ...)
        // (calculateEquivalentSquareUI, linearInterp1D, getFactor1D, interpolate2D, ...)
        // (getElectronOutputFactor, getEffectiveSSD, getElectronDmax, getApproxElectronPDD, ...)
        // (drawLine, drawLineCm, drawBeam, handleImageSelection, calculateMU, printResults, emailResults, resetForm, window.onload)
        // Ensure the window.onload logic initializes your calculator correctly.
        // --- Start: JS functions from user's file (condensed for brevity in this example) ---
        function displayError(message) { document.getElementById('output').innerHTML = `<p class="error">Error: ${message}</p>`; document.getElementById('printEmailButtons').style.display = 'none'; }
        function displayResult(mu, params) { const outputDiv = document.getElementById('output'); outputDiv.dataset.resultsText = formatResultsForText(mu, params); let html = `<h3>Calculation Results</h3><p><strong>Planner:</strong> ${params.plannerName||'N/A'}</p><p><strong>Rad Onc:</strong> ${params.radOncName||'N/A'}</p><p><strong>Field:</strong> ${params.fieldName||'N/A'}</p><hr><p><strong>Technique:</strong> ${params.technique}</p>`; if (params.technique === 'SSD' || params.technique === 'SAD') { html += `<p>Energy: ${params.energy} MV</p><p>FS: <span class="math-inline">\{params\.fieldWidth?\.toFixed\(1\)\}x</span>{params.fieldHeight?.toFixed(1)}cm (EqSq: ${params.fieldSize?.toFixed(2)})</p><p>Depth: ${params.depth}cm</p>`; html += params.technique === 'SSD' ? `<p>SSD: ${params.ssd}cm</p>` : `<p>SAD: ${params.sad}cm</p>`; html += `<p>Wedge: <span class="math-inline">\{params\.wedgeAngle\}° \(WF\:</span>{params.wedge?.toFixed(4)})</p><p>Tray: <span class="math-inline">\{params\.trayType\|\|'None'\} \(TF\:</span>{params.tray?.toFixed(4)})</p><hr><p><i>Details:</i> K:${params.K?.toFixed(4)}`; html += params.technique === 'SSD' ? ` PDD:<span class="math-inline">\{params\.PDD?\.toFixed\(4\)\} ISF\:</span>{params.ISF?.toFixed(4)}` : ` TMR:<span class="math-inline">\{params\.TMR?\.toFixed\(4\)\} ISF\:</span>{params.ISF?.toFixed(4)}`; html += ` Sc:<span class="math-inline">\{params\.Sc?\.toFixed\(4\)\} Sp\:</span>{params.Sp?.toFixed(4)}</p>`; } else if (params.technique === 'electron') { html += `<p>Energy: ${params.energy}MeV</p><p>Applicator: ${params.applicator||'N/A'}</p><p>Depth: ${params.depth}cm</p><p>SSD: <span class="math-inline">\{params\.ssd\_actual\}cm</p\><hr\><p\><i\>Details\:</i\> D0'/MU\:</span>{params.calibRate?.toFixed(4)} OF:<span class="math-inline">\{params\.OF?\.toFixed\(4\)\} PDD\:</span>{params.PDD?.toFixed(4)} EffSSD:<span class="math-inline">\{params\.SSD\_eff?\.toFixed\(1\)\} Dmax\:</span>{params.dmax?.toFixed(1)} Gap:<span class="math-inline">\{params\.gap?\.toFixed\(1\)\} ISF\:</span>{params.ISF?.toFixed(4)}</p>`; if(params.pddWarning) html+=`<div class="error" style="font-size:0.8em; padding:5px; background-color:#fff3cd; color:#856404; border-color:#ffeeba;">${params.pddWarning}</div>`} html += `<hr><p>Rx Dose: <span class="math-inline">\{params\.Rx\}cGy</p\><p\><strong\>Required MUs\: <span class\="final\-mu"\></span>{mu.toFixed(1)}</span></strong></p>`; outputDiv.innerHTML = html; document.getElementById('printEmailButtons').style.display = 'block'; }
        function formatResultsForText(mu, params) { let text = `MU Calculation Results...\nField: ${params.fieldName||'N/A'}\nTechnique: ${params.technique}\nPrescription Dose: ${params.Rx} cGy\nRequired MUs: ${mu.toFixed(1)}\n`; return text; } // Simplified
        function updatePhotonDefaults(){updateDmax(); updateWedgeFactor(); updateTrayFactor();}
        function updateElectronDefaults(){ const e=document.getElementById('electronEnergy').value, a=document.getElementById('applicatorSize').value; const dV=getElectronDmax(e); document.getElementById('dmaxElectron').value=(dV!==undefined&&!isNaN(dV))?dV.toFixed(1):'N/A'; const effSsdV=getEffectiveSSD(e,a); document.getElementById('effectiveSSDElectron').value=(effSsdV!==undefined&&!isNaN(effSsdV))?effSsdV.toFixed(1):'N/A'; const oF=getElectronOutputFactor(e,a); document.getElementById('outputFactorElectron').value=(oF!==undefined&&!isNaN(oF))?oF.toFixed(4):'N/A';}
        function updateDmax(){const e=document.getElementById('energy').value; const dV=referenceData[e]?.dmax; document.getElementById('dmax').value=(dV!==undefined&&!isNaN(dV))?dV.toFixed(1):'N/A';}
        function changeTechnique(){ const t=document.getElementById('technique').value, iS=t==='SAD',iE=t==='electron'; document.getElementById('photonInputs').style.display=iE?'none':'block'; document.getElementById('electronInputs').style.display=iE?'block':'none'; if(!iE){document.getElementById('ssdFields').style.display=iS?'none':'block'; document.getElementById('sadFields').style.display=iS?'block':'none'; updatePhotonDefaults(); updateJawInputs();}else{updateElectronDefaults(); drawBeam();} document.getElementById('output').innerHTML='Results...'; document.getElementById('printEmailButtons').style.display='none';}
        function updateWedgeFactor(){const e=document.getElementById('energy').value,wA=document.getElementById('wedgeAngle').value; let wF=wedgeFactors[e]?.[wA]; if(wF===undefined)wF=1.0; document.getElementById('wedgeFactor').value=wF.toFixed(4);}
        function updateTrayFactor(){const e=document.getElementById('energy').value,tT=document.getElementById('trayType').value; let tF=trayFactors[e]?.[tT]; if(tF===undefined)tF=1.0; document.getElementById('trayFactor').value=tF.toFixed(4);}
        function calculateEquivalentSquare(x,y){if(isNaN(x)||isNaN(y)||x<=0||y<=0)return NaN; const a=x*y,p=2*(x+y); if(p===0)return 0; return(4*a)/p;}
        function updateJawInputs(){const xS=document.getElementById('xsym').checked; document.getElementById('xSymInput').style.display=xS?'inline-block':'none'; document.getElementById('xIndepInput').style.display=xS?'none':'inline-block'; if(xS){const w=parseFloat(document.getElementById('xwidth').value)||0; document.getElementById('x1').value=(-w/2).toFixed(1); document.getElementById('x2').value=(w/2).toFixed(1);}else{const x1=parseFloat(document.getElementById('x1').value)||0,x2=parseFloat(document.getElementById('x2').value)||0; document.getElementById('xwidth').value=Math.max(0,x2-x1).toFixed(1);} const yS=document.getElementById('ysym').checked; document.getElementById('ySymInput').style.display=yS?'inline-block':'none'; document.getElementById('yIndepInput').style.display=yS?'none':'inline-block'; if(yS){const h=parseFloat(document.getElementById('ywidth').value)||0; document.getElementById('y1').value=(-h/2).toFixed(1); document.getElementById('y2').value=(h/2).toFixed(1);}else{const y1=parseFloat(document.getElementById('y1').value)||0,y2=parseFloat(document.getElementById('y2').value)||0; document.getElementById('ywidth').value=Math.max(0,y2-y1).toFixed(1);} calculateEquivalentSquareUI(); drawBeam();}
        function calculateEquivalentSquareUI(){const x1=parseFloat(document.getElementById('x1').value),x2=parseFloat(document.getElementById('x2').value),y1=parseFloat(document.getElementById('y1').value),y2=parseFloat(document.getElementById('y2').value); const cW=(!isNaN(x2)&&!isNaN(x1))?(x2-x1):NaN,cH=(!isNaN(y2)&&!isNaN(y1))?(y2-y1):NaN; const eS=calculateEquivalentSquare(cW,cH); const fSI=document.getElementById('fieldSize'); if(!isNaN(eS)){fSI.value=eS.toFixed(2); return eS;}else{fSI.value=''; return NaN;}}
        function linearInterp1D(x,xPs,yPs){if(!Array.isArray(xPs)||!Array.isArray(yPs)||xPs.length!==yPs.length||xPs.length<2){console.error("Invalid arrays for linearInterp1D");return NaN;} let x0=xPs[0],y0=yPs[0],x1=xPs[xPs.length-1],y1=yPs[yPs.length-1]; for(let i=1;i<xPs.length;i++){if(xPs[i]<xPs[i-1]){console.error("xPoints must be sorted");return NaN;}} if(isNaN(x)||x===null)return NaN; x=Number(x); if(x<=x0)return y0; if(x>=x1)return y1; for(let i=1;i<xPs.length;i++){if(x<=xPs[i]){x0=xPs[i-1];y0=yPs[i-1];x1=xPs[i];y1=yPs[i]; if(isNaN(y0)||isNaN(y1))return NaN; if(x1===x0)return y0; const f=(x-x0)/(x1-x0); return y0+(y1-y0)*f;}} console.error("Interpolation failed",x); return NaN;}
        function getFactor1D(fD,e,fS){fS=parseFloat(fS); if(isNaN(fS)||!fD||!fD[e])return NaN; const eD=fD[e]; const aS=Object.keys(eD).map(Number).sort((a,b)=>a-b); if(aS.length===0)return NaN; const aF=aS.map(s=>eD[s]); if(eD[fS]!==undefined&&!isNaN(eD[fS]))return eD[fS]; const vP=aS.reduce((acc,s,idx)=>{if(!isNaN(aF[idx])){acc.x.push(s);acc.y.push(aF[idx]);}return acc;},{x:[],y:[]}); if(vP.x.length<2){console.error(`Not enough valid points for factor: E=<span class="math-inline">\{e\},FS\=</span>{fS.toFixed(2)}`);return NaN;} const iF=linearInterp1D(fS,vP.x,vP.y); if(isNaN(iF))console.error(`Could not interp factor: E=<span class="math-inline">\{e\},FS\=</span>{fS.toFixed(2)}`); return iF;}
        function interpolate2D(dS,e,tFS,tD){tFS=parseFloat(tFS);tD=parseFloat(tD); if(isNaN(tFS)||isNaN(tD)||!dS||!dS[e]){console.error("Invalid input for 2D interp.",{dS,e,tFS,tD});return NaN;} const eD=dS[e]; const aFS=Object.keys(eD).map(Number).sort((a,b)=>a-b); if(aFS.length===0){console.error(`No field size data for E=${e}`);return NaN;} let fs1_idx=-1,fs2_idx=-1; if(tFS<=aFS[0])fs1_idx=fs2_idx=0; else if(tFS>=aFS[aFS.length-1])fs1_idx=fs2_idx=aFS.length-1; else{for(let i=1;i<aFS.length;i++){if(tFS<=aFS[i]){fs1_idx=i-1;fs2_idx=i;break;}}} if(fs1_idx===-1||fs2_idx===-1){console.error(`No bounding FS for ${tFS}`);return NaN;} const fs1=aFS[fs1_idx],fs2=aFS[fs2_idx]; const dFS1=eD[fs1],dFS2=eD[fs2]; if(!dFS1||!dFS2){console.error(`Missing depth data for FS ${fs1} or ${fs2}`);return NaN;} const dsFS1=Object.keys(dFS1).map(Number).sort((a,b)=>a-b),vsFS1=dsFS1.map(d=>dFS1[d]); const iVFS1=linearInterp1D(tD,dsFS1,vsFS1); const dsFS2=Object.keys(dFS2).map(Number).sort((a,b)=>a-b),vsFS2=dsFS2.map(d=>dFS2[d]); const iVFS2=linearInterp1D(tD,dsFS2,vsFS2); if(isNaN(iVFS1)||isNaN(iVFS2)){console.error(`Depth interp failed for FS <span class="math-inline">\{fs1\}/</span>{fs2} @ depth ${tD}. V: ${iVFS1}, ${iVFS2}`);return NaN;} if(fs1===fs2)return iVFS1; const fsF=(tFS-fs1)/(fs2-fs1); return iVFS1+(iVFS2-iVFS1)*fsF;}
        function getElectronOutputFactor(e,a){return electronOutputFactors[e]?.[a];}
        function getEffectiveSSD(e,a){return electronEffectiveSSDs[e]?.[a];}
        function getElectronDmax(e){return electronDmaxData[e];}
        function getApproxElectronPDD(e,a,d){const pddPD=electronApproxPDDData[e]?.[a]; if(!pddPD)return{value:NaN,warning:`Approx PDD only for 10x10, E=${e}MeV.`}; const ds=Object.keys(pddPD).map(Number).sort((a,b)=>a-b),ps=ds.map(dVal=>pddPD[dVal]); const iP=linearInterp1D(d,ds,ps); if(isNaN(iP))return{value:NaN,warning:`Could not interp approx PDD for D=${d}cm. Out of range?`}; return{value:iP,warning:null};}
        function drawLine(x1,y1,x2,y2,c='white',lW=2){if(!ctx)return; ctx.strokeStyle=c; ctx.lineWidth=lW; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();}
        function drawBeam(){if(!ctx)return; ctx.fillStyle="#111"; ctx.fillRect(0,0,beamDim,beamDim); if(currentImage&&currentImage.complete&&currentImage.naturalHeight!==0){try{const hR=beamDim/currentImage.naturalWidth,vR=beamDim/currentImage.naturalHeight,r=Math.min(hR,vR); const cSX=(beamDim-currentImage.naturalWidth*r)/2,cSY=(beamDim-currentImage.naturalHeight*r)/2; ctx.drawImage(currentImage,0,0,currentImage.naturalWidth,currentImage.naturalHeight,cSX,cSY,currentImage.naturalWidth*r,currentImage.naturalHeight*r);}catch(e){console.error("Err drawing img:",e); ctx.fillStyle="#111"; ctx.fillRect(0,0,beamDim,beamDim);}} const rC='#666',tL=4,tECm=20; drawLine(beamDim/2,0,beamDim/2,beamDim,rC,0.5); drawLine(0,beamDim/2,beamDim,beamDim/2,rC,0.5); ctx.font="10px Arial"; ctx.fillStyle=rC; for(let i=-tECm;i<=tECm;i++){if(i===0)continue; const tPx_x=beamDim/2+i*scale,tPx_y=beamDim/2-i*scale; const lT=(i%5===0),cTL=lT?tL*1.5:tL; drawLine(tPx_x,beamDim/2-cTL,tPx_x,beamDim/2+cTL,rC,0.5); drawLine(beamDim/2-cTL,tPx_y,beamDim/2+cTL,tPx_y,rC,0.5); if(lT){ctx.textAlign="center";ctx.textBaseline="top"; ctx.fillText(i,tPx_x,beamDim/2+cTL+2); ctx.textAlign="right";ctx.textBaseline="middle"; ctx.fillText(i,beamDim/2-cTL-4,tPx_y);}} const x1_cm=parseFloat(document.getElementById('x1').value)||0,x2_cm=parseFloat(document.getElementById('x2').value)||0,y1_cm=parseFloat(document.getElementById('y1').value)||0,y2_cm=parseFloat(document.getElementById('y2').value)||0; const rotD=parseFloat(document.getElementById('collimatorAngle').value)||0,rotR=rotD*(Math.PI/180.0); ctx.save(); ctx.translate(beamDim/2,beamDim/2); ctx.rotate(rotR); const xJC="rgba(255,255,0,0.7)",yJC="rgba(0,255,255,0.7)",jWPx=3; const x1_px=x1_cm*scale,x2_px=x2_cm*scale,y1_px=-y1_cm*scale,y2_px=-y2_cm*scale,ext_px=beamDim*0.6; drawLine(-ext_px,y1_px,ext_px,y1_px,yJC,jWPx); drawLine(-ext_px,y2_px,ext_px,y2_px,yJC,jWPx); drawLine(x1_px,-ext_px,x1_px,ext_px,xJC,jWPx); drawLine(x2_px,-ext_px,x2_px,ext_px,xJC,jWPx); ctx.restore();}
        function handleImageSelection(){const sV=document.querySelector('input[name="beamImage"]:checked').value,url=imageUrls[sV]; if(url){currentImage=new Image();currentImage.crossOrigin="Anonymous"; currentImage.onload=()=>{drawBeam();}; currentImage.onerror=()=>{console.error("Fail load img:",url);currentImage=null;drawBeam();}; currentImage.src=url;}else{currentImage=null;drawBeam();}}
        function calculateMU(){const oD=document.getElementById('output'); oD.innerHTML='Calculating...'; document.getElementById('printEmailButtons').style.display='none'; setTimeout(()=>{const p={}; let MU=NaN; try{p.plannerName=document.getElementById('plannerName').value;p.radOncName=document.getElementById('radOncName').value;p.fieldName=document.getElementById('fieldName').value;p.technique=document.getElementById('technique').value; if(p.technique==='SSD'||p.technique==='SAD'){p.energy=document.getElementById('energy').value; if(p.technique==='SSD'){p.Rx=parseFloat(document.getElementById('rxDose').value);p.depth=parseFloat(document.getElementById('depth').value);p.ssd=parseFloat(document.getElementById('ssd').value);p.dmax=parseFloat(document.getElementById('dmax').value);}else{p.Rx=parseFloat(document.getElementById('rxDoseSAD').value);p.depth=parseFloat(document.getElementById('depthSAD').value);p.sad=parseFloat(document.getElementById('sad').value);p.dmax=referenceData[p.energy]?.dmax;} p.fieldSize=parseFloat(document.getElementById('fieldSize').value); const x1=parseFloat(document.getElementById('x1').value),x2=parseFloat(document.getElementById('x2').value),y1=parseFloat(document.getElementById('y1').value),y2=parseFloat(document.getElementById('y2').value); p.fieldWidth=(!isNaN(x1)&&!isNaN(x2))?(x2-x1):NaN; p.fieldHeight=(!isNaN(y1)&&!isNaN(y2))?(y2-y1):NaN; p.trayType=document.getElementById('trayType').value;p.tray=parseFloat(document.getElementById('trayFactor').value);p.wedgeAngle=document.getElementById('wedgeAngle').value;p.wedge=parseFloat(document.getElementById('wedgeFactor').value); const iTV=[p.Rx,p.depth,p.fieldSize,p.tray,p.wedge]; if(p.technique==='SSD')iTV.push(p.ssd,p.dmax); if(p.technique==='SAD')iTV.push(p.sad); if(iTV.some(v=>isNaN(v)||v===null))throw new Error(`Invalid photon input(s).`); if(p.Rx<=0||p.fieldSize<=0||(p.technique==='SSD'&&p.ssd<=0))throw new Error(`Photon inputs must be positive.`); if(p.depth<0)throw new Error(`Depth negative.`); p.K=referenceData[p.energy]?.[p.technique]; if(p.K===undefined||isNaN(p.K))throw new Error(`K not found for ${p.energy}MV ${p.technique}.`); p.Sc=getFactor1D(scData,p.energy,p.fieldSize);p.Sp=getFactor1D(spData,p.energy,p.fieldSize); if(isNaN(p.Sc)||isNaN(p.Sp))throw new Error(`No Sc/Sp for EqSq ${p.fieldSize.toFixed(2)}.`); p.PDD=NaN;p.TMR=NaN;p.ISF=NaN; let den; if(p.technique==='SSD'){p.PDD=interpolate2D(pddData,p.energy,p.fieldSize,p.depth); if(isNaN(p.PDD))throw new Error(`No PDD for EqSq ${p.fieldSize.toFixed(2)}, D ${p.depth}.`); p.PDD/=100.0; if(p.ssd+p.depth<=0)throw new Error("Invalid SSD/Depth for ISF."); p.ISF=Math.pow((p.ssd+p.dmax)/(p.ssd+p.depth),2); if(isNaN(p.ISF))throw new Error("Fail ISF SSD."); den=p.K*p.PDD*p.Sc*p.Sp*p.tray*p.wedge*p.ISF;}else{p.TMR=interpolate2D(tmrData,p.energy,p.fieldSize,p.depth); if(isNaN(p.TMR))throw new Error(`No TMR for EqSq ${p.fieldSize.toFixed(2)}, D ${p.depth}.`); p.ISF=1.0; den=p.K*p.TMR*p.Sc*p.Sp*p.tray*p.wedge*p.ISF;} if(den===0||isNaN(den))throw new Error(`Photon calc fail - den zero/invalid (${den?.toFixed(4)}).`); MU=p.Rx/den;}else if(p.technique==='electron'){p.energy=document.getElementById('electronEnergy').value;p.applicator=document.getElementById('applicatorSize').value;p.Rx=parseFloat(document.getElementById('rxDoseElectron').value);p.depth=parseFloat(document.getElementById('depthElectron').value);p.ssd_actual=parseFloat(document.getElementById('ssdElectron').value); if(isNaN(p.Rx)||isNaN(p.depth)||isNaN(p.ssd_actual))throw new Error(`Invalid electron input(s).`); if(p.Rx<=0||p.ssd_actual<=0)throw new Error(`Electron Rx/SSD must be positive.`); if(p.depth<0)throw new Error(`Depth negative.`); p.calibRate=ELECTRON_CALIBRATION_DOSE_RATE;p.OF=getElectronOutputFactor(p.energy,p.applicator);p.SSD_eff=getEffectiveSSD(p.energy,p.applicator);p.dmax=getElectronDmax(p.energy); const{value:pV,warning:pW}=getApproxElectronPDD(p.energy,p.applicator,p.depth);p.PDD=pV/100.0;p.pddWarning=pW; if(p.OF===undefined||isNaN(p.OF))throw new Error(`OF not found for ${p.energy}MeV, ${p.applicator}.`); if(p.SSD_eff===undefined||isNaN(p.SSD_eff))throw new Error(`Eff SSD not found for ${p.energy}MeV, ${p.applicator}.`); if(p.dmax===undefined||isNaN(p.dmax))throw new Error(`Dmax not found for ${p.energy}MeV.`); if(isNaN(p.PDD))throw new Error(p.pddWarning||`No approx PDD for ${p.energy}MeV, ${p.applicator}, D ${p.depth}cm.`); p.gap=p.ssd_actual-ELECTRON_STANDARD_SSD; const isf_n=p.SSD_eff+p.dmax, isf_d=p.SSD_eff+p.depth+p.gap; if(isf_d<=0)throw new Error("Invalid geom for ISF (den<=0)."); p.ISF=Math.pow(isf_n/isf_d,2); if(isNaN(p.ISF))throw new Error("Fail ISF Electron."); const den=p.calibRate*p.OF*p.PDD*p.ISF; if(den===0||isNaN(den))throw new Error(`Electron calc fail - den zero/invalid (${den?.toFixed(4)}).`); MU=p.Rx/den;}else{throw new Error("Invalid technique.");} if(isNaN(MU))throw new Error("Calc resulted in NaN."); displayResult(MU,p);}catch(err){console.error("Calc Err:",err);displayError(err.message);}finally{drawBeam();}},0);}
        function printResults(){document.getElementById('controlButtons').style.visibility='hidden'; document.getElementById('printEmailButtons').style.visibility='hidden'; window.print(); document.getElementById('controlButtons').style.visibility='visible'; document.getElementById('printEmailButtons').style.visibility='visible';}
        function emailResults(){const oD=document.getElementById('output'); const rT=oD.dataset.resultsText||oD.innerText||"MU Calc Results N/A."; const subj="MU Calc Results: "+(document.getElementById('fieldName').value||"Unnamed Field"); const body=encodeURIComponent(rT); window.location.href=`mailto:?subject=<span class="math-inline">\{encodeURIComponent\(subj\)\}&body\=</span>{body}`;}
        function resetForm(){document.getElementById('plannerName').value=''; document.getElementById('radOncName').value=''; document.getElementById('fieldName').value=''; document.getElementById('technique').value='SSD'; document.getElementById('energy').value='6'; document.getElementById('rxDose').value='180'; document.getElementById('depth').value='5'; document.getElementById('ssd').value='100'; document.getElementById('rxDoseSAD').value='180'; document.getElementById('depthSAD').value='10'; document.getElementById('xsym').checked=true; document.getElementById('ysym').checked=true; document.getElementById('xwidth').value='10'; document.getElementById('ywidth').value='10'; document.getElementById('trayType').value='none'; document.getElementById('wedgeAngle').value='0'; document.getElementById('collimatorAngle').value='0'; document.getElementById('imgNone').checked=true; document.getElementById('electronEnergy').value='6'; document.getElementById('applicatorSize').value='10x10'; document.getElementById('rxDoseElectron').value='200'; document.getElementById('depthElectron').value='2.0'; document.getElementById('ssdElectron').value='100'; changeTechnique(); updatePhotonDefaults(); updateJawInputs(); handleImageSelection(); document.getElementById('output').innerHTML='Results...'; document.getElementById('printEmailButtons').style.display='none';}
        window.onload=()=>{canvas=document.getElementById('beamCanvas'); if(canvas.getContext){ctx=canvas.getContext('2d');}else{console.error("Canvas not supported.");alert("Canvas not supported - visualization fail.");} document.getElementById('technique').addEventListener('change',()=>{changeTechnique();calculateMU();}); document.getElementById('energy').addEventListener('change',()=>{updatePhotonDefaults();calculateMU();}); document.getElementById('trayType').addEventListener('change',()=>{updateTrayFactor();calculateMU();}); document.getElementById('wedgeAngle').addEventListener('change',()=>{updateWedgeFactor();calculateMU();}); document.getElementById('electronEnergy').addEventListener('change',()=>{updateElectronDefaults();calculateMU();}); document.getElementById('applicatorSize').addEventListener('change',()=>{updateElectronDefaults();calculateMU();}); document.querySelectorAll('input[name="xjawmode"], input[name="yjawmode"]').forEach(r=>{r.addEventListener('change',()=>{updateJawInputs();calculateMU();});}); document.querySelectorAll('.jawInputGroup input[type="number"]').forEach(i=>{i.addEventListener('input',()=>{updateJawInputs();calculateMU();});}); document.getElementById('collimatorAngle').addEventListener('input',drawBeam); document.querySelectorAll('input[name="beamImage"]').forEach(r=>{r.addEventListener('change',handleImageSelection);}); const mI=['rxDose','depth','ssd','rxDoseSAD','depthSAD','rxDoseElectron','depthElectron','ssdElectron']; mI.forEach(id=>{const el=document.getElementById(id); if(el)el.addEventListener('input',calculateMU);}); document.getElementById('resetButton').addEventListener('click',resetForm); resetForm();};
        // --- End: JS functions ---
    </script>
</body>
</html>
