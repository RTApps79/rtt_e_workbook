<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLC & Field Shaping Lab Activity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styles adapted from your provided simulator code & integrated with Tailwind theme */
        .simulator-wrapper { 
            background-color: #f0f8ff; 
            padding: 1.5rem;
            border-radius: 0.5rem; 
            border: 1px solid #b3d7ff;
            margin-top: 1.5rem;
        }
        .simulator-container-internal {
            background: #fff;
            padding: 1.5rem; /* Reduced padding slightly */
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap; 
            gap: 20px; /* Reduced gap */
            align-items: flex-start;
        }
        .controls-section, .visualizer-section {
            display: flex;
            flex-direction: column;
            flex-basis: calc(50% - 10px); /* Adjust for gap */
            flex-grow: 1;
            min-width: 280px; /* Ensure they don't get too squished */
        }
         .visualizer-section { align-items: center; }

        .simulator-container-internal h3, .simulator-container-internal h4 {
            margin-top: 0;
            color: #4c1d95; /* purple-800 */
            font-weight: 600; /* semibold */
        }
         .simulator-container-internal h3 { font-size: 1.25rem; margin-bottom: 1rem; } /* text-xl mb-4 */
        .simulator-container-internal h4 { font-size: 1.1rem; margin-bottom: 0.5rem; }


        .field-size-controls { gap: 10px; margin-top: 10px; display: flex; flex-direction: column; }
        .field-row { display: flex; justify-content: space-around; align-items: center; gap: 15px; margin-bottom: 10px; }
        .field-control-group { display: flex; align-items: center; gap: 5px; }
        .field-control-group label { min-width: 30px; font-weight: bold; margin: 0; color: #5b21b6; /* purple-700 */ font-size: 0.9rem; }
        .field-control-group button {
            padding: 2px 8px; font-size: 1.1em; line-height: 1; cursor: pointer;
            border: 1px solid #9ca3af; /* slate-400 */
            background-color: #e5e7eb; /* slate-200 */
            color: #374151; /* slate-700 */
            border-radius: 0.25rem; /* rounded-sm */
        }
        .field-control-group button:active { background-color: #d1d5db; /* slate-300 */ }
        .field-size-display {
            font-weight: bold; min-width: 45px; text-align: center; font-family: monospace;
            background: #e0f2fe; /* sky-100 */ color: #0c4a6e; /* sky-800 */
            padding: 4px 6px; border: 1px solid #7dd3fc; /* sky-300 */
            border-radius: 3px; font-size: 0.9rem;
        }

        #fieldDisplayContainer {
            width: 200px; height: 200px; /* Slightly larger for MLCs */
            border: 2px solid #60a5fa; /* blue-400 */
            position: relative; margin: 10px auto;
            background-color: #eff6ff; /* blue-50 */
            overflow: hidden;
        }
        #fieldDisplayContainer::before, #fieldDisplayContainer::after { content: ''; position: absolute; background-color: #93c5fd; /* blue-300 */ }
        #fieldDisplayContainer::before { width: 1px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
        #fieldDisplayContainer::after { width: 100%; height: 1px; top: 50%; left: 0; transform: translateY(-50%); }
        
        #fieldDisplayRect { /* Represents jaw-defined light field */
            position: absolute; 
            background-color: rgba(250, 204, 21, 0.4); /* Lighter Tailwind amber-300 with opacity */ 
            border: 1px dashed #f59e0b; /* Tailwind amber-500 */ 
        }
        /* MLC Shape Divs - to be positioned absolutely within fieldDisplayRect or fieldDisplayContainer */
        .mlc-shape {
            position: absolute;
            background-color: #bfdbfe; /* Tailwind blue-200, acts as a block */
            /* border: 1px solid #93c5fd; */ /* Optional border for MLC shapes */
        }

        .field-label { position: absolute; font-size: 9px; font-family: sans-serif; color: #4b5563; /* slate-600 */ background-color: rgba(255, 255, 255, 0.6); padding: 0 2px; border-radius: 2px; }
        .label-x1 { top: 50%; left: 2px; transform: translateY(-50%); }
        .label-x2 { top: 50%; right: 2px; transform: translateY(-50%); }
        .label-y1 { bottom: 2px; left: 50%; transform: translateX(-50%); } 
        .label-y2 { top: 2px; left: 50%; transform: translateX(-50%); }    
        #totalFieldDisplay, #mlcPatternDisplay { margin-top: 10px; text-align:center; font-family: monospace; font-weight: bold; color: #4c1d95; /* purple-800 */ font-size: 0.9rem;}

        .mlc-controls button {
            background-color: #a78bfa; /* purple-400 */ color: white;
            font-size: 0.85rem; padding: 6px 10px; margin: 5px;
        }
        .mlc-controls button:hover { background-color: #8b5cf6; /* purple-500 */ }
        .mlc-controls button.active-mlc { background-color: #6d28d9; /* purple-600 */ font-weight: bold; }


        /* Standard Styles from other activities */
        #start-screen-activity { background-color: #f0f8ff; border: 1px solid #b3d7ff; padding: 15px 25px; border-radius: 8px; margin-bottom: 30px; }
        #start-screen-activity h3 { color: #004085; margin-top: 15px; border-bottom: 1px solid #b3d7ff; padding-bottom: 5px; font-size:1.2rem; }
        #start-activity-btn { background-color: #28a745; font-size: 1.2em; padding: 12px 25px; display: block; margin: 25px auto 10px auto; }
        #start-activity-btn:hover { background-color: #218838; }

        body {font-family: 'Inter', sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; padding-bottom: 80px;}
        .main-content-wrapper { background-color: #fff; padding: 25px 35px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 900px; margin: 20px auto; }
        .nav-links-header { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; }
        footer { position: absolute; bottom: 0; left: 0; width: 100%; text-align: center; padding: 15px 0; background-color: #e9ecef; color: #6c757d; font-size: 0.9em; border-top: 1px solid #dee2e6; }
        .post-activity-nav { text-align: center; margin-top: 40px; padding: 20px; background-color: #f8f9fa; border-top: 1px solid #e9ecef; border-radius: 0 0 8px 8px; }
        .post-activity-nav button { margin: 5px 15px; background-color: #007bff; color:white; padding:10px 20px; border-radius:5px; border:none; cursor:pointer;}
        .post-activity-nav button:hover{ background-color: #0056b3;}
        .post-activity-nav button.repeat { background-color: #28a745; } .post-activity-nav button.repeat:hover { background-color: #218838; }
        .post-activity-nav button.menu { background-color: #6c757d; } .post-activity-nav button.menu:hover { background-color: #5a6268; }
        
        @media print {
            body * { visibility: hidden; }
            .nav-links-header, #start-screen-activity, #activity-area, .post-activity-nav, footer, button { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <header class="bg-white shadow-md sticky top-0 z-50 nav-links-header">
        <div class="container mx-auto px-6 py-3 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-xl font-bold text-purple-700 mb-2 sm:mb-0">MLC & Field Shaping Lab Activity</h1>
            <div class="flex flex-wrap justify-center sm:justify-end space-x-2">
                <a href="console_mlc_lesson.html#lesson-page-5" class="text-xs sm:text-sm bg-purple-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-purple-600 transition-colors duration-300 mb-1 sm:mb-0">
                    &larr; Back to MLC Lesson
                </a>
                <a href="../Modalities_Equipment_Terminology/index.html" class="text-xs sm:text-sm bg-purple-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-purple-600 transition-colors duration-300 mb-1 sm:mb-0">
                    &larr; Back to Modalities Menu
                </a>
                <a href="../../index.html" class="text-xs sm:text-sm bg-slate-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-slate-600 transition-colors duration-300 mb-1 sm:mb-0">
                    &larr; Main Workbook
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl px-4 sm:px-6 py-8 flex-grow main-content-wrapper">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-xl">
            <h1 class="text-3xl font-bold text-purple-700 mb-6 text-center border-b-2 border-purple-300 pb-4">Interactive MLC & Field Shaping Lab üõ†Ô∏è</h1>

            <div id="start-screen-activity" class="bg-purple-50 p-4 sm:p-6 rounded-lg shadow-md mb-8 border border-purple-200">
                <h2 class="text-2xl font-semibold text-purple-600 mb-4">Understanding Jaws & MLCs</h2>
                 <div class="mb-4 p-3 bg-purple-100 rounded-md border border-purple-200">
                    <h3 class="text-lg font-medium text-purple-700 mb-1">Purpose</h3>
                    <p class="text-sm text-slate-600">To understand and practice how X/Y collimator jaws define the overall field and how Multi-Leaf Collimators (MLCs) provide finer shaping within that field.</p>
                </div>
                <div class="mb-4 p-3 bg-purple-100 rounded-md border border-purple-200">
                    <h3 class="text-lg font-medium text-purple-700 mb-1">Task</h3>
                    <p class="text-sm text-slate-600">First, use the '+' and '-' buttons to adjust the X1, X2, Y1, and Y2 jaw settings and observe the light field (yellow rectangle). Then, select different pre-set "MLC Patterns" to see how they further shape the treatment area by blocking parts of the light field.</p>
                </div>
                 <div class="p-3 bg-purple-100 rounded-md border border-purple-200">
                    <h3 class="text-lg font-medium text-purple-700 mb-1">Criteria for Success</h3>
                    <p class="text-sm text-slate-600">Successfully manipulate jaw controls and apply MLC patterns to visualize different field shapes. Understand that MLCs refine the field defined by the jaws. (This is an exploratory activity.)</p>
                </div>
                <button id="start-activity-btn" onclick="startActivity()" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-5 rounded-lg text-base transition-colors duration-150 block mx-auto">Start Simulator</button>
            </div>

            <div id="activity-area" style="display: none;" class="simulator-wrapper">
                <div class="simulator-container-internal">
                    <div class="controls-section">
                        <h3 class="text-purple-700">Jaw Controls</h3>
                        <div class="field-size-controls">
                            <h4 class="text-purple-600">Field Size (cm)</h4>
                            <div class="field-row">
                                <div class="field-control-group">
                                    <label for="control-jawX1">X1:</label>
                                    <button onclick="changeFieldSize('X1', -0.5)">‚Äì</button> <span class="field-size-display" id="control-jawX1">5.0</span> <button onclick="changeFieldSize('X1', 0.5)">+</button>
                                </div>
                                <div class="field-control-group">
                                    <label for="control-jawX2">X2:</label>
                                    <button onclick="changeFieldSize('X2', -0.5)">‚Äì</button> <span class="field-size-display" id="control-jawX2">5.0</span> <button onclick="changeFieldSize('X2', 0.5)">+</button>
                                </div>
                            </div>
                            <div class="field-row">
                                <div class="field-control-group">
                                    <label for="control-jawY1">Y1:</label>
                                    <button onclick="changeFieldSize('Y1', -0.5)">‚Äì</button> <span class="field-size-display" id="control-jawY1">5.0</span> <button onclick="changeFieldSize('Y1', 0.5)">+</button>
                                </div>
                                <div class="field-control-group">
                                    <label for="control-jawY2">Y2:</label>
                                    <button onclick="changeFieldSize('Y2', -0.5)">‚Äì</button> <span class="field-size-display" id="control-jawY2">5.0</span> <button onclick="changeFieldSize('Y2', 0.5)">+</button>
                                </div>
                            </div>
                            <div id="totalFieldDisplay">Total Field: 10.0 x 10.0 cm</div>
                        </div>
                        <hr class="my-4 border-purple-200">
                        <h3 class="text-purple-700">MLC Pattern Selector</h3>
                        <div class="mlc-controls flex flex-wrap gap-2 justify-center">
                            <button id="mlc-open" onclick="selectMLCPattern('open')" class="active-mlc">Open (Match Jaws)</button>
                            <button id="mlc-block" onclick="selectMLCPattern('center-block')">Central Block</button>
                            <button id="mlc-cshape" onclick="selectMLCPattern('c-shape')">C-Shape</button>
                            <button id="mlc-diag" onclick="selectMLCPattern('diagonal')">Diagonal Block</button>
                        </div>
                         <div id="mlcPatternDisplay" class="mt-2">Current MLC Pattern: Open</div>
                         <button type="button" onclick="resetSimulator()" class="mt-6 bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors self-center">Reset All</button>
                    </div>

                    <div class="visualizer-section">
                        <h3 class="text-purple-700">Field Visualizer</h3>
                        <div id="fieldDisplayContainer">
                            <div id="fieldDisplayRect"></div>
                            <div id="mlc-mask-center-block" class="mlc-shape" style="display:none;"></div>
                            <div id="mlc-mask-cshape-top" class="mlc-shape" style="display:none;"></div>
                            <div id="mlc-mask-cshape-middle" class="mlc-shape" style="display:none;"></div>
                            <div id="mlc-mask-cshape-bottom" class="mlc-shape" style="display:none;"></div>
                            <div id="mlc-mask-diagonal" class="mlc-shape" style="display:none;">
                                </div>
                            <span class="field-label label-x1">X1</span>
                            <span class="field-label label-x2">X2</span>
                            <span class="field-label label-y1">Y1</span>
                            <span class="field-label label-y2">Y2</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="post-activity-nav" id="end-nav" style="display: none;">
                <h3 class="text-xl font-semibold text-slate-700 mb-4">Options</h3>
                <button class="menu" onclick="window.location.href='../Modalities_Equipment_Terminology/index.html'">Back to Modalities Menu</button> 
                <button class="repeat" onclick="startActivity()">Reset & Try Again</button>
                <button onclick="window.location.href='console_mlc_lesson.html#lesson-page-5'">Back to MLC Lesson</button>
            </div>
        </div>
    </main>

    <footer class="bg-slate-800 text-slate-300 py-6 mt-auto text-center">
        <div class="container mx-auto px-6">
            <p class="text-sm">&copy; <span id="currentYear"></span> RTApps. All Rights Reserved.</p>
            <p class="text-xs mt-1">MLC & Field Shaping Lab Activity</p>
        </div>
    </footer>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        let jawX1 = 5.0; 
        let jawX2 = 5.0; 
        let jawY1 = 5.0; 
        let jawY2 = 5.0; 
        let currentMLCPattern = 'open';

        const fieldDisplayContainerSize = 200; // Increased for better MLC viz
        const maxFieldCoordinate = 20.0; 
        const scaleFactor = (fieldDisplayContainerSize / 2.0) / maxFieldCoordinate; 

        const mlcMasks = {
            'center-block': document.getElementById('mlc-mask-center-block'),
            'c-shape-top': document.getElementById('mlc-mask-cshape-top'),
            'c-shape-middle': document.getElementById('mlc-mask-cshape-middle'),
            'c-shape-bottom': document.getElementById('mlc-mask-cshape-bottom'),
            'diagonal': document.getElementById('mlc-mask-diagonal')
        };


        function roundToDecimalPlace(num, places) { 
            const factor = 10 ** places; 
            return Math.round(num * factor) / factor; 
        }

        function updateFieldDisplay() { 
            const rect = document.getElementById('fieldDisplayRect'); 
            const cont = document.getElementById('fieldDisplayContainer');
            if (!rect || !cont) return; 

            let totalWidthCm = jawX1 + jawX2;
            let totalHeightCm = jawY1 + jawY2;

            let widthPx = Math.max(0, totalWidthCm * scaleFactor); 
            let heightPx = Math.max(0, totalHeightCm * scaleFactor); 
            
            let leftPx = (fieldDisplayContainerSize / 2.0) - (jawX1 * scaleFactor); 
            let topPx = (fieldDisplayContainerSize / 2.0) - (jawY2 * scaleFactor); 

            rect.style.width = `${widthPx}px`; 
            rect.style.height = `${heightPx}px`; 
            rect.style.left = `${leftPx}px`; 
            rect.style.top = `${topPx}px`; 

            document.getElementById('totalFieldDisplay').textContent = `Jaw Field: ${totalWidthCm.toFixed(1)}W x ${totalHeightCm.toFixed(1)}L cm`;
            applyMLCMask();
        }
        
        function hideAllMLCMasks() {
            for (const key in mlcMasks) {
                if (mlcMasks[key]) mlcMasks[key].style.display = 'none';
            }
        }

        function applyMLCMask() {
            hideAllMLCMasks();
            const jawRectLeft = (fieldDisplayContainerSize / 2.0) - (jawX1 * scaleFactor);
            const jawRectTop = (fieldDisplayContainerSize / 2.0) - (jawY2 * scaleFactor);
            const jawRectWidth = (jawX1 + jawX2) * scaleFactor;
            const jawRectHeight = (jawY1 + jawY2) * scaleFactor;

            if (currentMLCPattern === 'center-block' && mlcMasks['center-block']) {
                const blockWidth = jawRectWidth * 0.3; // 30% of field width
                const blockHeight = jawRectHeight * 0.3; // 30% of field height
                mlcMasks['center-block'].style.width = `${blockWidth}px`;
                mlcMasks['center-block'].style.height = `${blockHeight}px`;
                mlcMasks['center-block'].style.left = `${jawRectLeft + (jawRectWidth - blockWidth) / 2}px`;
                mlcMasks['center-block'].style.top = `${jawRectTop + (jawRectHeight - blockHeight) / 2}px`;
                mlcMasks['center-block'].style.display = 'block';
            } else if (currentMLCPattern === 'c-shape') {
                const stripHeight = jawRectHeight / 3;
                const sideWidth = jawRectWidth * 0.3;

                // Top bar of C
                if(mlcMasks['c-shape-top']) {
                    mlcMasks['c-shape-top'].style.width = `${jawRectWidth}px`;
                    mlcMasks['c-shape-top'].style.height = `${stripHeight}px`;
                    mlcMasks['c-shape-top'].style.left = `${jawRectLeft}px`;
                    mlcMasks['c-shape-top'].style.top = `${jawRectTop}px`;
                    mlcMasks['c-shape-top'].style.display = 'block';
                }
                // Middle vertical bar of C (on one side)
                 if(mlcMasks['c-shape-middle']) {
                    mlcMasks['c-shape-middle'].style.width = `${sideWidth}px`;
                    mlcMasks['c-shape-middle'].style.height = `${stripHeight}px`;
                    mlcMasks['c-shape-middle'].style.left = `${jawRectLeft}px`; // Left side
                    mlcMasks['c-shape-middle'].style.top = `${jawRectTop + stripHeight}px`;
                    mlcMasks['c-shape-middle'].style.display = 'block';
                 }
                // Bottom bar of C
                 if(mlcMasks['c-shape-bottom']) {
                    mlcMasks['c-shape-bottom'].style.width = `${jawRectWidth}px`;
                    mlcMasks['c-shape-bottom'].style.height = `${stripHeight}px`;
                    mlcMasks['c-shape-bottom'].style.left = `${jawRectLeft}px`;
                    mlcMasks['c-shape-bottom'].style.top = `${jawRectTop + 2 * stripHeight}px`;
                    mlcMasks['c-shape-bottom'].style.display = 'block';
                 }
            } else if (currentMLCPattern === 'diagonal' && mlcMasks['diagonal']) {
                // Simple rectangular block for diagonal for now
                mlcMasks['diagonal'].style.width = `${jawRectWidth * 0.4}px`;
                mlcMasks['diagonal'].style.height = `${jawRectHeight * 0.4}px`;
                mlcMasks['diagonal'].style.left = `${jawRectLeft + jawRectWidth * 0.1}px`;
                mlcMasks['diagonal'].style.top = `${jawRectTop + jawRectHeight * 0.1}px`;
                // True diagonal would need SVG or more complex CSS transform
                mlcMasks['diagonal'].style.display = 'block';
            }
            // 'open' pattern does nothing extra
        }

        function changeFieldSize(dimension, delta) { 
            const maxJawPos = 20.0; 
            let currentValueDisplayElement = document.getElementById('control-jaw' + dimension);
            switch (dimension) {
                case 'X1': jawX1 = Math.min(maxJawPos, Math.max(0, roundToDecimalPlace(jawX1 + delta, 1))); currentValueDisplayElement.textContent = jawX1.toFixed(1); break;
                case 'X2': jawX2 = Math.min(maxJawPos, Math.max(0, roundToDecimalPlace(jawX2 + delta, 1))); currentValueDisplayElement.textContent = jawX2.toFixed(1); break;
                case 'Y1': jawY1 = Math.min(maxJawPos, Math.max(0, roundToDecimalPlace(jawY1 + delta, 1))); currentValueDisplayElement.textContent = jawY1.toFixed(1); break;
                case 'Y2': jawY2 = Math.min(maxJawPos, Math.max(0, roundToDecimalPlace(jawY2 + delta, 1))); currentValueDisplayElement.textContent = jawY2.toFixed(1); break;
            }
            updateFieldDisplay(); 
        }
        
        function selectMLCPattern(patternName) {
            currentMLCPattern = patternName;
            document.getElementById('mlcPatternDisplay').textContent = `Current MLC Pattern: ${patternName.replace('-', ' ')}`;
            
            // Update active button style
            document.querySelectorAll('.mlc-controls button').forEach(btn => btn.classList.remove('active-mlc', 'bg-purple-600'));
            const activeBtn = document.getElementById(`mlc-${patternName.split('-')[0]}`); // a bit simplified for multi-word patterns
            if(activeBtn) activeBtn.classList.add('active-mlc', 'bg-purple-600');

            updateFieldDisplay();
        }

        function resetSimulator() {
            jawX1 = 5.0; jawX2 = 5.0; jawY1 = 5.0; jawY2 = 5.0;
            currentMLCPattern = 'open';
            document.getElementById('control-jawX1').textContent = jawX1.toFixed(1);
            document.getElementById('control-jawX2').textContent = jawX2.toFixed(1);
            document.getElementById('control-jawY1').textContent = jawY1.toFixed(1);
            document.getElementById('control-jawY2').textContent = jawY2.toFixed(1);
            selectMLCPattern('open'); // This will call updateFieldDisplay
        }

        function startActivity() {
            document.getElementById('start-screen-activity').style.display = 'none';
            document.getElementById('activity-area').style.display = 'block';
            document.getElementById('end-nav').style.display = 'block';
            resetSimulator();
        }

        document.addEventListener('DOMContentLoaded', () => {
            resetSimulator();
        });
    </script>
</body>
</html>